<!DOCTYPE html>

<html>
<head>
    <title> Integrative Bandit </title>
    <script src="js/jspsych.js"></script>
    <script src="js/plugin-html-keyboard-response.js"></script>
    <script src="js/plugin-image-keyboard-response.js"></script>
    <script src="js/plugin-fullscreen.js"></script>
    <script src="js/plugin-html-slider-response.js"></script>
    <script src="instructions.js"></script>
    <script src="experiment_config.js"></script>
    <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" type="text/css" />
</head>
<body>
</body>
<script>

// Define experiment parameters

var NUM_TRIALS = experiment_setup["NUM_TRIALS"];
var NUM_OPTIONS = experiment_setup["NUM_OPTIONS"];
const REWARD_PROBABILITIES = experiment_setup["REWARD_PROBABILITIES"]; //
const NAME = experiment_setup["NAME"];
const SOCIAL_VERSION = experiment_setup["SOCIAL_VERSION"]; 
// If REWARD_MATRIX is already in the correct format (nested arrays)
const allRewards = experiment_setup["REWARD_MATRIX"];
const FULL_FEEDBACK = experiment_setup["FULL_FEEDBACK"];
const imageIndices = experiment_setup["IMAGE_INDICES"];
const NUM_CONTEXTS = experiment_setup["NUM_CONTEXTS"];
const CONTEXT_INDICES = experiment_setup["CONTEXT_INDICES"];


// Initialize jsPsych
const jsPsych = initJsPsych({
    on_finish: function() {
        // Get all data and ignore multiple columns
        var all_data = jsPsych.data.get()
            .ignore([
            'stimulus',
            'trial_type',
            'internal_node_id',
            'view_history',
            'time_elapsed',
            'response_label',
            'slider_start',
            'success',
            'trial_index',
            'plugin_version',
            'total_reward'
        ])
        .filter([{tag: 'trial'}, {tag: 'rating'}]);

        // Download CSV file
        const filename = `bandit_data_${Date.now()}.csv`;
        all_data.localSave('csv', filename);
        
        // Also log to console for debugging
        console.log(all_data.csv());
    },
    show_progress_bar: true
});

// fullscreen
const enterFullscreen = {
    type: jsPsychFullscreen,
    fullscreen_mode: true,
    message: '<p>The experiment will start in fullscreen mode.</p><p>Click the button below to enter fullscreen mode.</p>',
    button_label: 'Enter Fullscreen',
    data: {
        tag: 'enter_fullscreen'
    }
};


// exit fullscreen
const exitFullscreen = {
    type: jsPsychFullscreen,
    fullscreen_mode: false,
    data: {
        tag: 'exit_fullscreen'
    }
};


// Welcome
const welcome = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `<h1>Welcome to the ${NAME} game</h1><p>[Press any key to continue]</p>`,
    data: {
        tag: 'welcome'
    } 
};


// Debrief
const debrief = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: function() {
        const totalReward = jsPsych.data.get().select('reward').sum();
        return `
            <h2>Experiment finished</h2>
            <p>Your total score: ${totalReward}</p>
            <p>Thank you for your participation!</p>
            <p>[Press any key to exit]</p>
        `;
    },
    data: {
        tag: 'debrief'
    }
};


//load images (context and arm)
// Function to generate image path from shape-color indices
function generateImagePath(imageType, shapeColorPair) {
    const [shape, color] = shapeColorPair;
    const folder = imageType === 'arm' ? `${SOCIAL_VERSION}/arm` : 'context';
    return `img/${folder}/${shape}-${color}.png`;
}

//Context pairs
// Add function to generate unique context pairs
function generateUniqueContextPairs(numPairs) {
    let shapes = Array.from({length: 6}, (_, i) => i + 1);
    let colors = Array.from({length: 6}, (_, i) => i + 1);
    
    // Shuffle arrays
    shapes = shuffleArray([...shapes]);
    colors = shuffleArray([...colors]);
    
    let pairs = [];
    for (let i = 0; i < numPairs; i++) {
        pairs.push([shapes[i], colors[i]]);
    }
    return pairs;
}

// Generate context pairs before image loading
const contextPairs = generateUniqueContextPairs(NUM_CONTEXTS);


//Arm pairs
const unshuffledimages = imageIndices.slice(0, NUM_OPTIONS).map(pair => 
    generateImagePath('arm', pair)
);

//shuffle the images
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}
const images = shuffleArray([...unshuffledimages]);

//context names
const contextNames = shuffleArray([
  "Nova",
  "Solis",
  "Aether",
  "Zephyr",
  "Lumis",
  "Orion",
  "Astra",
  "Vora",
  "Kryos",
  "Pyra"
]);

// Instructions
//social/non-social instruction depends on version; instruction tests are stored in instructions.js
//auto generate option stimulis based on the number of options
const instructions = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: function() {
        const text = instruction_texts[SOCIAL_VERSION];
        const gapPercentage = 5;
        const totalGapWidth = gapPercentage * (NUM_OPTIONS - 1);
        const optionWidth_raw = (100 - totalGapWidth) / NUM_OPTIONS;
        const optionWidth = Math.min(10, optionWidth_raw);
        const totalWidth = optionWidth_raw * NUM_OPTIONS + totalGapWidth;
             
        return `    
            <p><b>${text.title}</b></p>
            ${text.description.map(line => `<p>${line}</p>`).join('')}
            <p>${FULL_FEEDBACK ? 
                "You will see the outcomes of all options after each choice, whether or not you chose them." : 
                "You can only see the outcome of your chosen option after each choice."}</p>  
            <p>${text.choice_text}</p>  
            <div style='width: ${totalWidth}%; margin: 0 auto; display: flex; justify-content: center;'>
                ${Array(NUM_OPTIONS).fill().map((_, i) => `
                <div style='width: ${optionWidth}%; margin: 0 ${gapPercentage/2}%; text-align: center;'>
                    <img src='${images[i]}' style='width: 100%;'></img>
                    <p class='small'><strong>Press key ${i+1}</strong></p>
                </div>
                `).join('')}
            </div>
            <p>[Press any key to begin]</p>
        `;
    },
    data: function() {
        return {
            tag: 'instructions',
            version: SOCIAL_VERSION
        };
    }
};

// Create trial
//auto generate option stimulis based on the number of options
function createTrial(trialIndex) {
    return {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function() {
            const currentTotal = jsPsych.data.get().select('reward').sum() || 0;
            const remainingTrials = NUM_TRIALS - trialIndex;
            const gapPercentage = 5; // Gap between options (5% of screen width)
            const totalGapWidth = gapPercentage * (NUM_OPTIONS - 1); // Total width taken by gaps
            const optionWidth_raw = (100 - totalGapWidth) / NUM_OPTIONS;
            const optionWidth = Math.min(10, optionWidth_raw);
            const totalWidth = optionWidth_raw * NUM_OPTIONS + totalGapWidth;      
            return `
                <div style='width: 100%; text-align: center; margin-bottom: 20px;'>
                    <img src='${generateImagePath('context', contextPairs[CONTEXT_INDICES[trialIndex]])}' 
                         style='max-width: 150px;'></img>
                    <p><strong>${contextNames[CONTEXT_INDICES[trialIndex]]}</strong></p>
                    <p>Current Total Score: ${currentTotal}</p>
                    <p>Remaining Trials: ${remainingTrials}</p>
                </div>
                <div style='width: ${totalWidth}%; margin: 0 auto; display: flex; justify-content: center;'>
                ${Array(NUM_OPTIONS).fill().map((_, i) => `
                    <div style='width: ${optionWidth}%; margin: 0 ${gapPercentage/2}%; text-align: center;'>
                        <img src='${images[i]}' style='width: 100%;'></img>
                        <p class='small'><strong>Press key ${i+1}</strong></p>
                    </div>
                `).join('')}
                </div>
            `;
        },
        choices: Array(NUM_OPTIONS).fill().map((_, i) => (i + 1).toString()),
        on_finish: function(data) {
            const choice = parseInt(data.response) - 1;
            const reward = allRewards[trialIndex][choice];
            data.reward = reward;
            data.context = CONTEXT_INDICES[trialIndex];
            data.total_reward = jsPsych.data.get().select('reward').sum();
        },
        data: {
            tag: 'trial'
        }
    };
}


// Feedback
function createFeedback(trialIndex) {
    return {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function() {
            const lastTrial = jsPsych.data.get().last(1).values()[0];
            const choice = parseInt(lastTrial.response) - 1;
            const remainingTrials = NUM_TRIALS - trialIndex;
            const gapPercentage = 5;
            const totalGapWidth = gapPercentage * (NUM_OPTIONS - 1);
            const optionWidth_raw = (100 - totalGapWidth) / NUM_OPTIONS;
            const optionWidth = Math.min(10, optionWidth_raw);
            const totalWidth = optionWidth_raw * NUM_OPTIONS + totalGapWidth;
            
            return `
                <div>
                    <div style='width: 100%; text-align: center; margin-bottom: 20px;'>
                        <img src='${generateImagePath('context', contextPairs[CONTEXT_INDICES[trialIndex]])}' 
                             style='max-width: 150px;'></img>
                        <p><strong>${contextNames[CONTEXT_INDICES[trialIndex]]}</strong></p>
                        <p>Current Total Score: ${lastTrial.total_reward}</p>
                        <p>Remaining Trials: ${remainingTrials-1}</p>
                    </div>
                    <div style='width: ${totalWidth}%; margin: 0 auto; display: flex; justify-content: center;'>
                        ${images.map((img, index) => {
                            const isSelected = index === choice;
                            const reward = allRewards[trialIndex][index];
                            const showReward = FULL_FEEDBACK || isSelected;
                            
                            return `
                                <div style='width: ${optionWidth}%; margin: 0 ${gapPercentage/2}%; text-align: center;'>
                                    <div style='${isSelected ? "border: 3px solid #333333; padding: 5px;" : ""}'>
                                        <img src='${img}' style='width: 100%; object-fit: contain;'></img>
                                        <p class='small'><strong>${SOCIAL_VERSION === 'social' ? 
                                            `Partner ${index + 1}` : 
                                            `Option ${index + 1}`}</strong></p>
                                        ${!isSelected && showReward ? `<p class='small' style='color: #666; font-style: italic;'>
                                            Forgone outcome: ${reward}
                                        </p>` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div style='text-align: center; margin-top: 20px;'>
                        <p>${SOCIAL_VERSION === 'social' ? 
                            `You chose Partner ${choice + 1}` :
                            `You chose Option ${choice + 1}`}</p>
                        <p>Your gain in this round: ${lastTrial.reward}</p>
                    </div>
                </div>
                <p>[Press any key to continue]</p>
            `;
        },
        data: {
            tag: 'feedback',
            context: CONTEXT_INDICES[trialIndex]
        }
    };
}




// Create probability rating trials for each arm
const probabilityRatings = images.map((image, index) => {
    return {
        type: jsPsychHtmlSliderResponse,
        stimulus: `
            <div style='margin: 2em 0;'>
                <img src='${image}' style='width: 30%; height: 30%; object-fit: contain;'></img>
                <p><strong>${SOCIAL_VERSION === 'social' ? 
                    `How reliable is Partner ${index + 1}?` : 
                    `How rewarding is Option ${index + 1}?`}</strong></p>
                <p style='font-size: 0.8em; color: #666;'>${SOCIAL_VERSION === 'social' ?
                    '(0 = Very unreliable, 100 = Very reliable)' :
                    '(0 = Very bad, 100 = Very good)'}</p>
            </div>
        `,
        labels: ['0%', '100%'],
        slider_width: 500,
        require_movement: true,
        data: {
            tag: `rating`,
            arm: index + 1
        }
    };
});


// Create experiment timeline
let timeline = [enterFullscreen, welcome, instructions];

for (let i = 0; i < NUM_TRIALS; i++) {
    timeline.push(createTrial(i));
    timeline.push(createFeedback(i));
}

// Add all probability ratings to timeline
probabilityRatings.forEach(rating => {
    timeline.push(rating);
});

timeline.push([debrief, exitFullscreen]);

// Run experiment
jsPsych.run(timeline);

</script>
</html>
